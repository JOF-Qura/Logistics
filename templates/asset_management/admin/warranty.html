<div class="card-header">
    <h3 class="card-title">List of Warranties</h3>
    <button type="button" class="btn btn-primary float-right" data-toggle="modal" data-target="#addWarranty">
        Add Warranty <i class="fas fa-plus mr-1"></i>
      </button>
</div>

<div class="card-body">
    <div class="row">
        <div class="col-12">
            <table id="warranty_table" class="table table-bordered table-hover"
            style = "width: 100% !important">
                <thead>
                <tr>
                <th>ID</th>
                <th>Length(Months)</th>
                <th>Expiration</th>
                <th>Contact</th>
                <th>Email</th>
                <th>Note</th>
                <th>Action</th>
                </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="addWarranty" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Add Warranty</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="card-body">
              <form id="addAssetWarrantyForm">
                  <div class="form-row">
                      <div class="form-group col-sm-6 ">
                          <label for="add_warranty_length">Length in Months</label><label style="color: red;">*</label>
                          <input required type="number" class="form-control" name="add_warranty_length" id="add_warranty_length"  >
                      </div>
                      <div class="form-group col-sm-6 ">
                        <label for="add_warranty_exp">Expiration</label><label style="color: red;">*</label>
                        <input required type="date" class="form-control" name="add_warranty_exp" id="add_warranty_exp"  >
                    </div>
                  </div>
                  <div class="form-row">
                      <div class="form-group col-sm-12">
                          <label for="add_warranty_contact">Contact</label>
                          <input style="margin-top: 10px;" rows="2" cols="50" class="form-control" name="add_warranty_contact" id="add_warranty_contact">
                      </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group col-sm-12">
                        <label for="add_warranty_email">Email</label>
                        <input type="email" style="margin-top: 10px;" rows="2" cols="50" class="form-control" name="add_warranty_email" id="add_warranty_email">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-sm-12">
                        <label for="add_warranty_note">Note</label>
                        <textarea style="margin-top: 10px;" rows="2" cols="50" class="form-control" name="add_warranty_note" id="add_warranty_note">
                        </textarea>
                    </div>
                </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <input type="submit" class="btn btn-primary" id="addAssetWarrantyBtn">
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="viewWarranty" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Add Warranty</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="card-body">
              <form id="addAssetWarrantyForm">
                  <div class="form-row">
                      <div class="form-group col-sm-6 ">
                          <label for="view_warranty_length">Length in Months</label><label style="color: red;">*</label>
                          <span required type="number" class="form-control" name="view_warranty_length" id="view_warranty_length"  >
                            <span>
                        </div>
                      <div class="form-group col-sm-6 ">
                        <label for="view_warranty_exp">Expiration</label><label style="color: red;">*</label>
                        <span required type="date" class="form-control" name="view_warranty_exp" id="view_warranty_exp"  >
                        <span>
                    </div>
                  </div>
                  <div class="form-row">
                      <div class="form-group col-sm-12">
                          <label for="view_warranty_contact">Contact</label>
                          <span style="margin-top: 10px;" rows="2" cols="50" class="form-control" name="view_warranty_contact" id="view_warranty_contact">
                            <span>
                        </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group col-sm-12">
                        <label for="view_warranty_email">Email</label>
                        <span type="email" style="margin-top: 10px;" rows="2" cols="50" class="form-control" name="view_warranty_email" id="view_warranty_email">
                        <span>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-sm-12">
                        <label for="add_warranty_note">Note</label>
                        <span style="margin-top: 10px;" rows="2" cols="50" class="form-control" name="add_warranty_note" id="add_warranty_note">
                        <span>
                    </div>
                </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
<div class="modal fade" id="confirm_delete_warranty">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title text-secondary"><i class="fas fa-exclamation-triangle"></i>&nbsp;&nbsp;Delete Warranty</h4>
          <button type="button" class="btn btn-sm btn-default" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true"><i class="fas fa-times"></i></span>
          </button>
        </div>
        <div class="modal-body">
          <p>Are you sure to delete this warranty?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-info confirmed_delete_warranty">Yes, delete it.</button>
        </div>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>
  <!-- /.modal -->

<script src="{{url_for('static', path='/plugins/jquery/jquery.min.js')}}"></script>
<script>

$(document).ready(function () {
    id = "{{id}}"
    $("#warranty_table").DataTable({

        ajax: "/asset_management/api/Asset_warranty/asset_warranty/" + id,
        dom: 'Blfrtip',
        buttons: [
            'copy',
            'csv',
            'excel',
            {
              extend: 'pdfHtml5',
              orientation: 'landscape',
              pageSize: 'LEGAL'
          },
          'print',
            
        ],
        columns: [
                { data: "warranty_id"},
                { data: "warranty_length"},
                { data: "expiration_date", render:function(data){
                    return moment(data).format('LL') +
                    "<div class='text-secondary font-italic'>" + moment(data).startOf('seconds').fromNow()+"</div>"
                  }
                },
                { data: "warranty_contact"},
                { data: "warranty_email"},
                { data: "warranty_note"},
                { data: "active_status", render: function(data, type, row){
                    if(data == "Active"){
                        return '<div class="text-center dropdown"><div class="btn btn-sm btn-default" data-toggle="dropdown" role="button"><i class="fas fa-ellipsis-v"></i></div>' +
                          '<div class="dropdown-menu dropdown-menu-right">' +
                              '<div class="dropdown-item d-flex btn_view" id="'+ row.warranty_id +'" role="button">' +
                                '<div style="width: 2rem"><i class="fas fa-eye"></i></div>' +
                                '<div>View Warranty</div></div>' +
                                  '<div class="dropdown-item d-flex btn_delete_warranty" id="'+ row.warranty_id +'" role="button">' +
                                    '<div style="width: 2rem"><i class="fas fa-trash-alt"></i></div>' +
                                    '<div style="color: red">Delete Warranty</div></div></div></div>';
                    }  
                    else{
                        return '<button class="btn btn-danger >Activate</button>';
                    }
                }
                
            },
        ],
        "aoColumnDefs": [{ "bVisible": false, "aTargets": [0] }]
        
        })

});


$("#addAssetWarrantyForm").on("submit", function(e){

    e.preventDefault();

    id = "{{id}}"
    form =  {asset_id: id, 
            warranty_length: $(add_warranty_length).val(),
            expiration_date: new Date($(add_warranty_exp).val()),
            warranty_contact: $(add_warranty_contact).val(),
            warranty_email: $(add_warranty_email).val(),
            warranty_note: $(add_warranty_note).val(),
            created_by: sessionStorage.getItem("id")
                };

    encoded = JSON.stringify(form)
    console.log(form)

        $.ajax({
            url:'/asset_management/api/Asset_warranty/',
            type: "POST",
            data: encoded,
            dataType: "JSON",
            contentType: "application/json",

            success: function(data){
            document.getElementById("addAssetWarrantyForm").reset();
            $('#addWarranty').modal('hide');

            toastr.success('Warranty added successfully')
            refresh_warranty();
            }
        })
    });


    function refresh_warranty(){

        $('#warranty_table').DataTable().ajax.reload();
    }


    $(document).on("click", ".btn_view", function(){
        var id = this.id;
  
          $.ajax({
              url: '/asset_management/api/Asset_warranty/' + id,
              type: "GET",
              data: { id: id },
              dataType: "JSON",
          
              success: function(data){
                  console.log(data);
                  var warrantyInfo = data.data;
  
                  $('#view_warranty_length').val(warrantyInfo.warranty_length);
                  $('#view_warranty_exp').html(warrantyInfo.expiration_date);
                  $('#view_warranty_contact').html(warrantyInfo.warranty_contact);
                  $('#view_warranty_email').html(warrantyInfo.warranty_email);
                  $('#view_warranty_note').html(warrantyInfo.warranty_note);
  
                  $('#viewWarranty').modal('show');
              }
          // ajax closing tag
          })
      });


      $(document).on("click", ".btn_delete_warranty", function(){
        var id = this.id;
        $('#confirm_delete_warranty').modal('show');
        
        $(document).on("click", ".confirmed_delete_warranty", function(){
          
            $.ajax({
              url: '/asset_management/api/Asset_warranty/'+id,
              type: "DELETE",
              data: { id: id },
              dataType: "JSON",
          
              success: function(data){
                $('#confirm_delete_warranty').modal('hide');
                toastr.info('Warranty deleted successfully')
                refresh_warranty();
              }
          // ajax closing tag
          })
          
        });
        
      });

      
</script>
</div>